<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Block Blast</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
      import { getDatabase, ref, set, onDisconnect } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDur6NqZyFIVzpi3WXWq3qB0u8RMwNUvHw",
        authDomain: "block-blast-99621.firebaseapp.com",
        projectId: "block-blast-99621",
        storageBucket: "block-blast-99621.firebasestorage.app",
        messagingSenderId: "576779446919",
        appId: "1:576779446919:web:7ea5fab7ba8634bb772622",
        databaseURL: "https://block-blast-99621-default-rtdb.europe-west1.firebasedatabase.app/"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      const rtdb = getDatabase(app);

      // –ì–ª–æ–±–∞–ª—å–Ω–∏–π –æ–±'—î–∫—Ç –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ –¥–∞–Ω–∏–º–∏ —á–µ—Ä–µ–∑ script.js
      window.GameDB = {
        // –°–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è —Ä–µ–∫–æ—Ä–¥—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç—ñ (Firestore)
        async syncPlayer(user, currentBest) {
          if (!user || user.id === "guest") return currentBest;
          const userRef = doc(db, "players", String(user.id));
          try {
            const snap = await getDoc(userRef);
            let best = currentBest;
            if (snap.exists()) {
              best = Math.max(snap.data().bestScore || 0, currentBest);
            }
            // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–º'—è —Ç–∞ —Ä–µ–∫–æ—Ä–¥ —É –±–∞–∑—ñ
            await setDoc(userRef, {
              name: user.first_name || "–ì—Ä–∞–≤–µ—Ü—å",
              bestScore: best,
              lastActive: serverTimestamp()
            }, { merge: true });
            return best;
          } catch (e) {
            console.error("Firebase Sync Error:", e);
            return currentBest;
          }
        },

        // –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ —Ä–µ–∫–æ—Ä–¥—É (Firestore)
        async updateScore(userId, score) {
          if (!userId || userId === "guest") return;
          const userRef = doc(db, "players", String(userId));
          await setDoc(userRef, {
            bestScore: score,
            lastActive: serverTimestamp()
          }, { merge: true });
        },

        // –í—ñ–¥—Å—Ç–µ–∂–µ–Ω–Ω—è –∂–∏–≤–æ–≥–æ –æ–Ω–ª–∞–π–Ω—É (Realtime Database)
        trackOnline(userId) {
          if (!userId || userId === "guest") return;
          const onlineRef = ref(rtdb, 'online/' + userId);
          // –°—Ç–∞–≤–∏–º–æ —Å—Ç–∞—Ç—É—Å "online"
          set(onlineRef, true);
          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –≤–∏–¥–∞–ª—è—î–º–æ —Å—Ç–∞—Ç—É—Å –ø—Ä–∏ –∑–∞–∫—Ä–∏—Ç—Ç—ñ –≤–∫–ª–∞–¥–∫–∏
          onDisconnect(onlineRef).remove();
        }
      };
    </script>

    <div id="game-container">
        <button id="settings-btn" class="icon-btn">‚öôÔ∏è</button>

        <div class="stats">
            <div id="score">–û—á–∫–∏: 0</div>
            <div id="best-score">–ù–∞–π–∫—Ä–∞—â–∏–π: 0</div>
        </div>

        <canvas id="gameCanvas" width="320" height="320"></canvas>

        <div id="next-blocks"></div>

        <div id="game-over-modal" class="modal">
            <div class="modal-content">
                <h2>–ì—Ä—É –∑–∞–∫—ñ–Ω—á–µ–Ω–æ!</h2>
                <p id="final-score">–¢–≤—ñ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: 0</p>
                <p id="final-best">–ù–∞–π–∫—Ä–∞—â–∏–π: 0</p>
                <button id="restart-btn">–ì—Ä–∞—Ç–∏ –∑–Ω–æ–≤—É üéÆ</button>
            </div>
        </div>

        <div id="settings-modal" class="modal">
            <div class="modal-content">
                <h2>–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</h2>
                <div class="setting-row">
                    <span>–ú—É–∑–∏–∫–∞</span>
                    <input type="checkbox" id="music-toggle" checked>
                </div>
                <div class="setting-row">
                    <span>–ó–≤—É–∫</span>
                    <input type="checkbox" id="sound-toggle" checked>
                </div>
                <div class="setting-row">
                    <span>–í—ñ–±—Ä–∞—Ü—ñ—è</span>
                    <input type="checkbox" id="vibe-toggle" checked>
                </div>
                <hr>
                <div class="setting-row">
                    <span class="label-text">Replay</span>
                    <button id="restart-from-settings" class="action-btn">Play</button>
                </div>
                <div class="setting-row">
                    <span class="label-text">More settings</span>
                    <button id="more-settings-btn" class="action-btn set-btn">Set</button>
                </div>
                <button id="close-settings" class="close-link">–ù–∞–∑–∞–¥</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
</body>
</html>
